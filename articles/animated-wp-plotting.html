<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making Animated Win Probability Charts with cfbfastR â€¢ cfbfastR</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- docsearch --><script src="../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Making Animated Win Probability Charts with cfbfastR">
<meta property="og:description" content="Step-by-step walk-through of the process of adapting &lt;a href='https://twitter.com/LeeSharpeNFL' target='blank'&gt;Lee Sharpe's&lt;/a&gt; win probability charts to college football using data from &lt;a href='https://www.collegefootballdata.com' target='blank'&gt;CollegeFootballData.com&lt;/a&gt; collected using the &lt;code&gt;cfbfastR&lt;/code&gt; package for R.">
<meta property="og:image" content="https://github.com/saiemgilani/cfbfastR-data/blob/master/themes/social_card_cfbfastR_final_quote.png?raw=true">
<meta property="og:image:alt" content="When you code good, you know good. When you know good, you win good. When you win good, they pay good.">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@JaredDLee">
<meta name="twitter:site" content="@cfbfastR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-SE5ZJL93W6"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-SE5ZJL93W6');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cfbfastR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.6.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-code"></span>
     
    Funcs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../reference/index.html">Function Index</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">cfbfastR Data</li>
    <li>
      <a href="../reference/load_cfb_pbp.html">Load Full Season PBP Data</a>
    </li>
    <li>
      <a href="../reference/update_cfb_db.html">Update or Create Database</a>
    </li>
    <li>
      <a href="../reference/cfbd_pbp_data.html">Play-by-Play Data</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">CFB Data</li>
    <li>
      <a href="../reference/register_cfbd.html">CFBD API Keys</a>
    </li>
    <li>
      <a href="../reference/cfbd_games.html">Games</a>
    </li>
    <li>
      <a href="../reference/cfbd_play.html">Plays</a>
    </li>
    <li>
      <a href="../reference/cfbd_drives.html">Drives</a>
    </li>
    <li>
      <a href="../reference/cfbd_teams.html">Teams</a>
    </li>
    <li>
      <a href="../reference/cfbd_players.html">Players</a>
    </li>
    <li>
      <a href="../reference/cfbd_stats.html">Statistics</a>
    </li>
    <li>
      <a href="../reference/cfbd_metrics.html">Metrics</a>
    </li>
    <li>
      <a href="../reference/cfbd_ratings.html">Ratings</a>
    </li>
    <li>
      <a href="../reference/cfbd_draft.html">Draft</a>
    </li>
    <li>
      <a href="../reference/cfbd_betting.html">Betting</a>
    </li>
    <li>
      <a href="../reference/cfbd_recruiting.html">Recruiting</a>
    </li>
    <li>
      <a href="../reference/cfbd_coaches.html">Coaches</a>
    </li>
    <li>
      <a href="../reference/cfbd_conferences.html">Conferences</a>
    </li>
    <li>
      <a href="../reference/cfbd_venues.html">Venues</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">ESPN Data</li>
    <li>
      <a href="../reference/espn_metrics.html">ESPN Metrics</a>
    </li>
    <li>
      <a href="../reference/espn_ratings.html">ESPN Ratings</a>
    </li>
    <li>
      <a href="../reference/espn_cfb_scoreboard.html">ESPN Scoreboard</a>
    </li>
    <li>
      <a href="../reference/espn_cfb_pbp.html">ESPN PBP</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-book-reader"></span>
     
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/index.html">Vignettes</a>
    </li>
    <li class="dropdown-header">Introductory</li>
    <li>
      <a href="../articles/intro.html">CFB Analytics with cfbfastR</a>
    </li>
    <li>
      <a href="../articles/animated-wp-plotting.html">Animated Win Probability Plots</a>
    </li>
    <li>
      <a href="../articles/fourth-down-plot-tutorial.html">Fourth Down Tendency Plots</a>
    </li>
    <li>
      <a href="../articles/rolling-epa-graph.html">Rolling EPA Graphs</a>
    </li>
    <li>
      <a href="../articles/nth-rated-recruit.html">Visualizing Team Talent with Player Recruit Rankings</a>
    </li>
    <li>
      <a href="../articles/map-tutorial.html">Intro to Visualizing Recruiting Geography</a>
    </li>
    <li class="dropdown-header">Expected Points Model Fundamentals</li>
    <li>
      <a href="../articles/college-football-expected-points-model-fundamentals-part-i.html">Part 1 - Model Definition</a>
    </li>
    <li>
      <a href="../articles/college-football-expected-points-model-fundamentals-part-ii.html">Part 2 - Regression Models</a>
    </li>
    <li>
      <a href="../articles/college-football-expected-points-model-fundamentals-part-iii.html">Part 3 - History of Expected Points Models</a>
    </li>
    <li class="dropdown-header">CFBD Tutorials</li>
    <li>
      <a href="../articles/cfbd_betting.html">CFBD Betting</a>
    </li>
    <li>
      <a href="../articles/cfbd_games.html">CFBD Games</a>
    </li>
    <li>
      <a href="../articles/cfbd_plays.html">CFBD Plays</a>
    </li>
    <li>
      <a href="../articles/cfbd_recruiting.html">CFBD Recruiting</a>
    </li>
    <li>
      <a href="../articles/cfbd_stats.html">CFBD Stats</a>
    </li>
    <li>
      <a href="../articles/cfbd_teams.html">CFBD Teams</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">
    <span class="fas fa-newspaper"></span>
     
     News
  </a>
</li>
<li>
  <a href="http://gameonpaper.com/cfb">
    <span class="fas fa-football-ball"></span>
     
     GP
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-project-diagram"></span>
     
    SDV
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://sportsdataverse.org/">SportsDataverse</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">R Packages</li>
    <li>
      <a href="https://hoopR.sportsdataverse.org/">hoopR</a>
    </li>
    <li>
      <a href="https://wehoop.sportsdataverse.org/">wehoop</a>
    </li>
    <li>
      <a href="https://saiemgilani.github.io/recruitR/">recruitR</a>
    </li>
    <li>
      <a href="https://puntalytics.github.io/puntr">puntr</a>
    </li>
    <li>
      <a href="https://jacklich10.github.io/gamezoneR/">gamezoneR</a>
    </li>
    <li>
      <a href="https://kazink36.github.io/cfbplotR/">cfbplotR</a>
    </li>
    <li>
      <a href="https://kazink36.github.io/cfb4th/">cfb4th</a>
    </li>
    <li>
      <a href="https://jaseziv.github.io/worldfootballR/">worldfootballR</a>
    </li>
    <li>
      <a href="https://BillPetti.github.io/baseballr/">baseballr</a>
    </li>
    <li>
      <a href="https://hockeyr.netlify.app/">hockeyR</a>
    </li>
    <li>
      <a href="https://BenHowell71.github.io/whockeyR/">whockeyR</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Python Packages</li>
    <li>
      <a href="https://py.sportsdataverse.org/">sportsdataverse-py</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Node.js Packages</li>
    <li>
      <a href="https://saiemgilani.github.io/sportsdataverse/">sportsdataverse.js</a>
    </li>
    <li>
      <a href="https://github.com/nntrn/nfl-nerd/">nfl-nerd</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fas fa-database"></span>
     
     Data
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://collegefootballdata.com">CFBData.com</a>
    </li>
    <li>
      <a href="https://github.com/saiemgilani/cfbfastR-data">Data Repository</a>
    </li>
    <li>
      <a href="https://github.com/saiemgilani/cfbfastR-raw">Raw Data Repository</a>
    </li>
  </ul>
</li>
<li>
  <a></a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="http://twitter.com/cfbfastR">
    <span class="fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/saiemgilani/cfbfastR/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="animated-wp-plotting_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making Animated Win Probability Charts with cfbfastR</h1>
                        <h4 class="author">Jared Lee <br><a href="https://twitter.com/JaredDLee" target="blank"><img src="https://img.shields.io/twitter/follow/JaredDLee?color=blue&amp;label=%40JaredDLee&amp;logo=twitter&amp;style=for-the-badge" alt="@JaredDLee"></a> <a href="https://github.com/Kazink36" target="blank"><img src="https://img.shields.io/github/followers/Kazink36?color=eee&amp;logo=Github&amp;style=for-the-badge" alt="@Kazink36"></a>
</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/saiemgilani/cfbfastR/blob/master/vignettes/animated-wp-plotting.Rmd"><code>vignettes/animated-wp-plotting.Rmd</code></a></small>
      <div class="hidden name"><code>animated-wp-plotting.Rmd</code></div>

    </div>

    
    
<p>Have you ever wanted to make an <a href="https://kazink36.github.io/images/animated_wp_ex_wide.gif">animated win probability chart</a> for college football like <a href="https://twitter.com/LeeSharpeNFL">Lee Sharpe</a> makes for <a href="https://twitter.com/LeeSharpeNFL/status/1300526539344289792">the NFL</a>? This document will walk you step-by-step through the process of adapting <a href="https://github.com/leesharpe/nfldata/blob/master/code/wpchart.R">Sharpeâ€™s code</a> to college football using data from <a href="collegefootballdata.com">CollegeFootballData.com</a> collected using the <code>cfbfastR</code> package for R.</p>
<p>-<a href="https://twitter.com/JaredDLee">Jared Lee</a></p>
<div id="load-and-install-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#load-and-install-packages" class="anchor"></a>Load and Install Packages</h2>
<p>Weâ€™re going to need several packages to generate the winning percentage plot: <code>tidyverse</code> for easy data wrangling, string manipulation, and plotting, <code>glue</code> to easily make the labels, <code>ggimage</code> to put the logos on the plot, and <code>animation</code> to actually build the GIF.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html">requireNamespace</a></span><span class="op">(</span><span class="st">'pacman'</span>, quietly <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">'pacman'</span><span class="op">)</span>
<span class="op">}</span>
<span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">tidyverse</span>, <span class="va">animation</span>, <span class="va">glue</span>, <span class="va">zoo</span>, <span class="va">ggimage</span>, <span class="va">cfbfastR</span><span class="op">)</span></code></pre></div>
</div>
<div id="cfbfastr" class="section level2">
<h2 class="hasAnchor">
<a href="#cfbfastr" class="anchor"></a>cfbfastR</h2>
<p>Weâ€™ll start by picking a team, a week, and a year and using <code>cfbfastR</code>â€™s functions to pull the play-by-play and the game info. <code><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data()</a></code> will grab the play-by-play info and make sure that epa_wpa is TRUE to get the win probabilities for the plot. <code><a href="../reference/cfbd_game_info.html">cfbd_game_info()</a></code> will pull the game info such as the home and away team and the result.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">team</span> <span class="op">&lt;-</span> <span class="st">"Utah"</span>
<span class="va">week</span> <span class="op">&lt;-</span> <span class="fl">1</span>
<span class="va">year</span> <span class="op">&lt;-</span> <span class="fl">2019</span>

<span class="va">interp_TimeSecsRem</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pbp</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>TimeSecsRem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">TimeSecsRem</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/stats/lag.html">lag</a></span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">)</span>, <span class="cn">NA</span>, <span class="va">TimeSecsRem</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu">select</span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">)</span>
  <span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span> <span class="op">==</span> <span class="fl">1800</span><span class="op">)</span>
  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1800</span>
  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">[</span><span class="va">ind</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
  <span class="va">pbp</span><span class="op">&lt;-</span> <span class="va">pbp</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>TimeSecsRem <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/na.approx.html">na.approx</a></span><span class="op">(</span><span class="va">temp</span><span class="op">$</span><span class="va">TimeSecsRem</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">mutate</span><span class="op">(</span>clock.minutes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">TimeSecsRem</span><span class="op">/</span><span class="fl">60</span><span class="op">)</span>,clock.seconds <span class="op">=</span> <span class="va">TimeSecsRem</span> <span class="op">%%</span> <span class="fl">60</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pbp</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">game_pbp</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data</a></span><span class="op">(</span><span class="va">year</span>, team <span class="op">=</span> <span class="va">team</span>, week <span class="op">=</span> <span class="va">week</span>, epa_wpa <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">down</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">interp_TimeSecsRem</span><span class="op">(</span><span class="op">)</span> 
  
<span class="va">game</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_game_info.html">cfbd_game_info</a></span><span class="op">(</span>year<span class="op">=</span><span class="va">year</span>, team <span class="op">=</span> <span class="va">team</span>, week <span class="op">=</span> <span class="va">week</span><span class="op">)</span></code></pre></div>
<p>Weâ€™ll also use the <code><a href="../reference/cfbd_team_info.html">cfbd_team_info()</a></code> function to pull the color and logo information and add it to the game info. Weâ€™ll also add in a <code>result</code> column that is the score difference between the home and the away teams that weâ€™ll use later.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">team_info</span> <span class="op">&lt;-</span> <span class="fu">cfbfastR</span><span class="fu">::</span><span class="fu"><a href="../reference/cfbd_team_info.html">cfbd_team_info</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">team_logos</span> <span class="op">&lt;-</span> <span class="va">team_info</span> <span class="op">%&gt;%</span>
  <span class="fu">select</span><span class="op">(</span><span class="va">school</span>, <span class="va">color</span>, <span class="va">alt_color</span>, <span class="va">logos</span>, <span class="va">alt_name2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>logo <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">logos</span>, <span class="fu">magrittr</span><span class="fu">::</span><span class="va"><a href="https://magrittr.tidyverse.org/reference/aliases.html">extract2</a></span>, <span class="fl">1</span><span class="op">)</span>,
         logo <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">logo</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu">select</span><span class="op">(</span><span class="op">-</span><span class="va">logos</span><span class="op">)</span>
<span class="va">game</span> <span class="op">&lt;-</span> <span class="va">game</span> <span class="op">%&gt;%</span> 
  <span class="fu">inner_join</span><span class="op">(</span><span class="va">team_logos</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"away_team"</span> <span class="op">=</span> <span class="st">"school"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">rename</span><span class="op">(</span>away_logo <span class="op">=</span> <span class="va">logo</span>, away_color <span class="op">=</span> <span class="va">color</span>, away_alt_color <span class="op">=</span> <span class="va">alt_color</span>, away_abr <span class="op">=</span> <span class="va">alt_name2</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">inner_join</span><span class="op">(</span><span class="va">team_logos</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"home_team"</span> <span class="op">=</span> <span class="st">"school"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">rename</span><span class="op">(</span>home_logo <span class="op">=</span> <span class="va">logo</span>, home_color <span class="op">=</span> <span class="va">color</span>, home_alt_color <span class="op">=</span> <span class="va">alt_color</span>, home_abr <span class="op">=</span> <span class="va">alt_name2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>result <span class="op">=</span> <span class="va">home_points</span> <span class="op">-</span> <span class="va">away_points</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>home_score <span class="op">=</span> <span class="va">home_points</span>, away_score <span class="op">=</span> <span class="va">away_points</span><span class="op">)</span></code></pre></div>
<p>To build the labels, weâ€™re going to use a custom function to pull the player names out of the play text. <a href="https://twitter.com/SaiemGilani">Saiem Gilani</a> wrote the bulk of the regular expressions here to get the names. EDIT: The improved version of this is now included in the <code><a href="../reference/cfbd_pbp_data.html">cfbd_pbp_data()</a></code> function by default.</p>
<p>Now we are ready to transform our play-by-play data frame to match what we need to work with Lee Sharpeâ€™s animation code. First, we will rename several columns that are similar between <code>cfbfastR</code> and <code>nflfastR</code> to match <code>nflfastR</code>â€™s column names. Then we need to create a few new columns that <code>cfbfastR</code> doesnâ€™t have. <code>game_seconds_remaining</code> is really just renaming <code>TimeSecsRem</code> but correcting for the half. <code>result</code> grabs from the game information and is the difference in the home and away score. We create the <code>time</code> column to use as the clock on the right side of the animation.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">game_pbp</span> <span class="op">&lt;-</span> <span class="va">game_pbp</span> <span class="op">%&gt;%</span>
  <span class="fu">rename</span><span class="op">(</span>qtr <span class="op">=</span> <span class="va">period</span>, wp <span class="op">=</span> <span class="va">wp_before</span>, posteam <span class="op">=</span> <span class="va">pos_team</span>, defteam <span class="op">=</span> <span class="va">def_pos_team</span>,
         away_team <span class="op">=</span> <span class="va">away</span>, home_team <span class="op">=</span> <span class="va">home</span>, play_id <span class="op">=</span> <span class="va">game_play_number</span>,
         posteam_score <span class="op">=</span> <span class="va">pos_team_score</span>, defteam_score <span class="op">=</span> <span class="va">def_pos_team_score</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>game_seconds_remaining <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">half</span> <span class="op">==</span> <span class="fl">1</span>, <span class="va">TimeSecsRem</span> <span class="op">+</span> <span class="fl">1800</span>, <span class="va">TimeSecsRem</span><span class="op">)</span>,
         result <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">result</span>,
         minlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">clock.minutes</span> <span class="op">&gt;=</span> <span class="fl">15</span>,
                           <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">clock.minutes</span> <span class="op">==</span> <span class="fl">15</span> <span class="op">&amp;</span> <span class="va">clock.seconds</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fl">15</span>, <span class="va">clock.minutes</span> <span class="op">-</span> <span class="fl">15</span><span class="op">)</span>,
                           <span class="va">clock.minutes</span><span class="op">)</span>,
         minlabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">minlabel</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="va">minlabel</span><span class="op">)</span>, <span class="va">minlabel</span><span class="op">)</span>,
         seclabel <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">clock.seconds</span> <span class="op">&lt;</span> <span class="fl">10</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"0"</span>, <span class="va">clock.seconds</span><span class="op">)</span>, <span class="va">clock.seconds</span><span class="op">)</span>,
         time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">minlabel</span>, <span class="st">":"</span>, <span class="va">seclabel</span><span class="op">)</span><span class="op">)</span> </code></pre></div>
<p>Now that our data matches <code>nflfastR</code>, we can start to copy Lee Sharpeâ€™s code and the bulk of the remaining code is his with a few minor adjustments to the plot, the overtime logic, and the labels. First we filter out plays that donâ€™t have a win percentage and fix the win probability so that it is always the probability of the away team winning.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">base_wp_data</span> <span class="op">&lt;-</span> <span class="va">game_pbp</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wp</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>s <span class="op">=</span> <span class="va">game_seconds_remaining</span>,
         wp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">wp</span>, <span class="fl">1</span> <span class="op">-</span> <span class="va">wp</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Then we fix the plays without a wpa.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># fix if play other than last is NA</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">target_wp</span> <span class="op">&lt;-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span>
    <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">target_wp</span> <span class="op">-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>
  <span class="op">}</span>
<span class="op">}</span>
<span class="co"># fix if last play is NA</span>
<span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">)</span>
  <span class="va">move_to</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>
  <span class="va">delta</span> <span class="op">&lt;-</span> <span class="va">move_to</span> <span class="op">-</span> <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>
  <span class="va">base_wp_data</span><span class="op">$</span><span class="va">wpa</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">base_wp_data</span><span class="op">$</span><span class="va">posteam</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">==</span> <span class="va">game</span><span class="op">$</span><span class="va">away_team</span>, <span class="va">delta</span>, <span class="op">-</span><span class="va">delta</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now we create the labels. This generates labels for any play that had a change in the winning percentage of more than 10 percentage points. Weâ€™ll also simplify our data frame by only selecting the relevant columns for our plots.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">abs_wpa</span> <span class="op">&lt;-</span> <span class="fl">0.07</span>

<span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">base_wp_data</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    helped<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">wpa</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">posteam</span>, <span class="va">defteam</span><span class="op">)</span>,
    text <span class="op">=</span> 
      <span class="fu">case_when</span><span class="op">(</span>
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff"</span> <span class="op">&amp;</span> 
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">kickoff_returner_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Rush"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} Rush"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Pass Reception"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{receiver_player_name} Catch"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Sack"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{sack_player_name} SACK"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt"</span> <span class="op">~</span> <span class="st">""</span>,<span class="co">#glue("{punt_returner_player_name} PR"),</span>
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Pass Incompletion"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{passer_player_name} Incomplete"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FUMBLE"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Penalty"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"PENALTY"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Missed"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG MISS"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Passing Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{receiver_player_name} TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Rushing Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span>
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fg_kicker_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{fg_kicker_player_name} FG GOOD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Field Goal Good"</span> <span class="op">&amp;</span>
         <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">fg_kicker_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG GOOD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Timeout"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Interception Return"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{interception_player_name} INT"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Own)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{rusher_player_name} Rush"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Field Goal"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG BLK"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return (Offense)"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} PUNT BLK"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Interception Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{interception_player_name} DEF TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Return Touchdown"</span> <span class="op">&amp;</span> 
         <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">kickoff_returner_player_name</span><span class="op">)</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{kickoff_returner_player_name} KR TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{punt_returner_player_name} PR TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Recovery (Opponent) Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FUMBLE TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Fumble Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FUMBLE TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Safety"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"SAFETY"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} PR FUMBLE TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Kickoff Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} KR FUMBLE TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Punt Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{punt_returner_player_name} PR TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Uncategorized"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Blocked Punt Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} PUNT BLK TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"placeholder"</span> <span class="op">~</span> <span class="st">""</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{posteam} FG MISS"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Missed Field Goal Return Touchdown"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} FGR TD"</span><span class="op">)</span>,
       <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span> <span class="op">&gt;</span> <span class="va">abs_wpa</span> <span class="op">&amp;</span> <span class="va">play_type</span> <span class="op">==</span> <span class="st">"Defensive 2pt Conversion"</span> <span class="op">~</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"{defteam} DEF 2PT"</span><span class="op">)</span>,
       <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">""</span><span class="op">)</span>,
    text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">text</span> <span class="op">==</span> <span class="st">""</span>,<span class="st">""</span>, <span class="fu">glue</span><span class="op">(</span><span class="st">"{text}\n{helped} +{abs(round(100*wpa))}%"</span><span class="op">)</span><span class="op">)</span>,
    away_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">posteam_score</span>, <span class="va">defteam_score</span><span class="op">)</span>,
    home_score <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">==</span> <span class="va">away_team</span>, <span class="va">defteam_score</span>, <span class="va">posteam_score</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">select</span><span class="op">(</span><span class="va">play_id</span>, <span class="va">qtr</span>, <span class="va">time</span>, <span class="va">s</span>, <span class="va">wp</span>, <span class="va">wpa</span>, <span class="va">posteam</span>, <span class="va">away_score</span>, <span class="va">home_score</span>, <span class="va">text</span><span class="op">)</span></code></pre></div>
<p>This is where the real magic happens. Sharpeâ€™s code will iterate over the labels and try to determine valid locations for each one.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># points for plotting</span>
<span class="va">x_max</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">x_lab_min</span> <span class="op">&lt;-</span> <span class="fl">3600</span> <span class="op">-</span> <span class="fl">250</span>
<span class="va">x_lab_max</span> <span class="op">&lt;-</span> <span class="va">x_max</span> <span class="op">+</span> <span class="fl">250</span>
<span class="va">x_score</span> <span class="op">&lt;-</span> <span class="fl">320</span> <span class="op">-</span> <span class="va">x_max</span>
<span class="co"># determine the location of the label</span>
<span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
<span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span> <span class="fu">arrange</span><span class="op">(</span><span class="fu">desc</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="va">wpa</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">seq_fix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">move</span><span class="op">)</span>
<span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">move</span> <span class="op">&lt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">start</span> <span class="op">&lt;</span> <span class="va">end</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">move</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="va">start</span> <span class="op">&gt;</span> <span class="va">end</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">end</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span>, <span class="va">move</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">r</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">text</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
<span class="op">{</span>
  <span class="co"># ordered list of spots this label could go</span>
  <span class="va">y_side</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">0.5</span>
  <span class="kw">if</span> <span class="op">(</span><span class="va">y_side</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span>, <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">y_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span>, <span class="fl">0.95</span>, <span class="fl">0.1</span><span class="op">)</span>, <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span>, <span class="fl">0.05</span>, <span class="op">-</span><span class="fl">0.1</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="co"># iterate, see if this spot is valid</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">)</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> 
             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">wp</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                    <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="co"># too close to the WP line</span>
      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
    <span class="op">}</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> 
             <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">y_text</span> <span class="op">&amp;</span> <span class="va">y_text</span> <span class="op">&lt;</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                    <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="va">x_text</span> <span class="op">&amp;</span> <span class="va">x_text</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="co"># too close to another label</span>
      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
    <span class="op">}</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">valid</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="co"># we found a spot for it, store and break loop</span>
      <span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> 
      <span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">y_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
      <span class="kw">break</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="co"># try x_spots?</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">valid</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="va">x_side</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="fl">1800</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">x_side</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="va">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">400</span>, <span class="va">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span><span class="op">)</span>,
                   <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">400</span>, <span class="va">x_lab_min</span>, <span class="fl">200</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
      <span class="va">x_spots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">400</span>, <span class="va">x_lab_min</span>, <span class="fl">200</span><span class="op">)</span>,
                   <span class="fu">seq_fix</span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">400</span>, <span class="va">x_lab_max</span>, <span class="op">-</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x_spots</span><span class="op">)</span><span class="op">)</span>
    <span class="op">{</span>
      <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">wp</span> <span class="op">&amp;</span> <span class="va">wp</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                      <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">300</span> <span class="op">&lt;</span> <span class="va">s</span> <span class="op">&amp;</span> <span class="va">s</span> <span class="op">&lt;</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">300</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
      <span class="op">{</span>
        <span class="co"># too close to the WP line</span>
        <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
      <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">wp_data</span> <span class="op">%&gt;%</span> 
               <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">-</span> <span class="fl">0.1</span> <span class="op">&lt;</span> <span class="va">y_text</span> <span class="op">&amp;</span> <span class="va">y_text</span> <span class="op">&lt;</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">+</span> <span class="fl">0.1</span> <span class="op">&amp;</span>
                      <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">-</span> <span class="fl">600</span> <span class="op">&lt;</span> <span class="va">x_text</span> <span class="op">&amp;</span> <span class="va">x_text</span> <span class="op">&lt;</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">+</span> <span class="fl">600</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span>
      <span class="op">{</span>
        <span class="co"># too close to another label</span>
        <span class="va">valid</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
      <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="va">valid</span><span class="op">)</span>
      <span class="op">{</span>
        <span class="co"># we found a spot for it, stop loop</span>
        <span class="va">wp_data</span><span class="op">$</span><span class="va">x_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x_spots</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
        <span class="va">wp_data</span><span class="op">$</span><span class="va">y_text</span><span class="op">[</span><span class="va">r</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">wp_data</span><span class="op">$</span><span class="va">wp</span><span class="op">[</span><span class="va">r</span><span class="op">]</span>
        <span class="kw">break</span>
      <span class="op">}</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="co"># warn about the labels not placed</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">valid</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/warning.html">warning</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"No room for ({wp_data$s[r]},{round(wp_data$wp[r], 3)}):"</span>,
                       <span class="st">"{gsub('\n',' ',wp_data$text[r])}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></code></pre></div>
<p>Finally, we create two new rows to our data frame for the start and end of the game, filter out any other weirdness, and arrange our data frame by the order of the plays.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># add on WP boundaries</span>
<span class="va">first_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>play_id <span class="op">=</span> <span class="fl">0</span>, qtr <span class="op">=</span> <span class="fl">1</span>, time <span class="op">=</span> <span class="st">"15:00"</span>, s <span class="op">=</span> <span class="fl">3600</span>,
                        wp <span class="op">=</span> <span class="fl">0.5</span>, wpa <span class="op">=</span> <span class="cn">NA</span>, text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>,
                        x_text <span class="op">=</span> <span class="fl">3600</span>, y_text <span class="op">=</span> <span class="fl">0.5</span>, away_score <span class="op">=</span> <span class="fl">0</span>, home_score <span class="op">=</span> <span class="fl">0</span>,
                        stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">last_row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>play_id <span class="op">=</span> <span class="fl">999999</span>, qtr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span>, s <span class="op">=</span> <span class="va">x_max</span> <span class="op">-</span> <span class="fl">1</span>,
                       time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">5</span>, <span class="st">"FINAL\nOT"</span>, <span class="st">"FINAL"</span><span class="op">)</span>,
                       wp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">result</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>,
                       wpa <span class="op">=</span> <span class="cn">NA</span>, text <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span>, x_text <span class="op">=</span> <span class="va">x_max</span>, y_text <span class="op">=</span> <span class="fl">0.5</span>,
                       away_score <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_score</span>, home_score <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_score</span>,
                       stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">wp_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">posteam</span> <span class="op">!=</span> <span class="st">""</span>,
         <span class="va">wpa</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">first_row</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">bind_rows</span><span class="op">(</span><span class="va">last_row</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">arrange</span><span class="op">(</span><span class="va">play_id</span><span class="op">)</span></code></pre></div>
</div>
<div id="plotting" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting" class="anchor"></a>Plotting</h2>
<p>Now weâ€™re ready for plotting. The <code>draw_frame()</code> function will draw our win probability plot for any given number of seconds remaining in the game. This is where you can make any changes to the plot that you would like.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draw_frame</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span>
<span class="op">{</span>
  
  <span class="co"># frame data</span>
  <span class="va">frm_data</span> <span class="op">&lt;-</span> <span class="va">wp_data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">s</span> <span class="op">&gt;=</span> <span class="va">n_sec</span><span class="op">)</span>
  
  <span class="co"># output quarter changes</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">frm_data</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">qtr</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">qtr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>
  <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"Plotting pbp in quarter {max(frm_data$qtr)}"</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># plot</span>
  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_data</span> <span class="op">%&gt;%</span> 
    <span class="fu">ggplot</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">wp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_vline</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3600</span>, <span class="va">x_max</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#5555AA"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_segment</span><span class="op">(</span>x <span class="op">=</span> <span class="op">-</span><span class="fl">3600</span>, xend <span class="op">=</span> <span class="op">-</span><span class="va">x_max</span>, y <span class="op">=</span> <span class="fl">0.5</span>, yend <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_image</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.82</span>, image <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_logo</span>, size <span class="op">=</span> <span class="fl">0.08</span>, asp <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_image</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.18</span>, image <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_logo</span>, size <span class="op">=</span> <span class="fl">0.08</span>, asp <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>color <span class="op">=</span> <span class="va">..y..</span> <span class="op">&lt;</span> <span class="fl">.5</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">game</span><span class="op">$</span><span class="va">away_color</span>, <span class="va">game</span><span class="op">$</span><span class="va">home_color</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_x_continuous</span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"reverse"</span>,
                       minor_breaks <span class="op">=</span> <span class="cn">NULL</span>,
                       labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"KICK\nOFF"</span>, <span class="st">"END\nQ1"</span>, <span class="st">"HALF\nTIME"</span>, <span class="st">"END\nQ3"</span>, <span class="st">"FINAL"</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">3600</span>, <span class="fl">0</span>, <span class="op">-</span><span class="fl">900</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3700</span>, <span class="va">x_max</span> <span class="op">-</span> <span class="fl">490</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">scale_y_continuous</span><span class="op">(</span>labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">glue</span><span class="op">(</span><span class="st">"{game$home_abr} 100%"</span><span class="op">)</span>,
                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$home_abr} 75%"</span><span class="op">)</span>,
                                  <span class="st">"50%"</span>,
                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$away_abr} 75%"</span><span class="op">)</span>,
                                  <span class="fu">glue</span><span class="op">(</span><span class="st">"{game$away_abr} 100%"</span><span class="op">)</span><span class="op">)</span>,
                       breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span>, <span class="fl">1</span><span class="op">)</span>,
                       limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">coord_cartesian</span><span class="op">(</span>clip <span class="op">=</span> <span class="st">"off"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">ylab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">labs</span><span class="op">(</span>title <span class="op">=</span> <span class="fu">glue</span><span class="op">(</span><span class="st">"Win Probability Chart: {game$season} Week {game$wk} {game$away_team} @ {game$home_team}"</span><span class="op">)</span>,
         caption <span class="op">=</span> <span class="st">"Data from cfbfastR, Visualization by @LeeSharpeNFL, Adapted for CFB by @JaredDLee"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span>
  
  <span class="co"># score display </span>
  <span class="va">away_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">away_score</span><span class="op">)</span>
  <span class="va">home_score</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">home_score</span><span class="op">)</span>
  
  <span class="co"># clock display</span>
  <span class="va">qtr</span> <span class="op">&lt;-</span> <span class="fu">case_when</span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"1st"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span> <span class="op">~</span> <span class="st">"2nd"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">3</span> <span class="op">~</span> <span class="st">"3rd"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span> <span class="op">~</span> <span class="st">"4th"</span>,
    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span> <span class="op">==</span> <span class="fl">5</span> <span class="op">~</span> <span class="st">"OT"</span>,
    <span class="cn">TRUE</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">qtr</span><span class="op">)</span><span class="op">)</span>
  <span class="op">)</span>
  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span>
  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">clock</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">==</span> <span class="st">"0"</span>, <span class="fu"><a href="https://rdrr.io/r/base/substr.html">substr</a></span><span class="op">(</span><span class="va">clock</span>, <span class="fl">2</span>, <span class="fl">100</span><span class="op">)</span>, <span class="va">clock</span><span class="op">)</span>
  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="va">qtr</span>, <span class="st">"\n"</span>, <span class="va">clock</span><span class="op">)</span>
  <span class="va">clock</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span><span class="op">(</span><span class="st">"FINAL"</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">frm_data</span><span class="op">$</span><span class="va">time</span>, <span class="fl">1</span><span class="op">)</span>, <span class="va">clock</span><span class="op">)</span>
  
  <span class="co"># add score and clock to plot</span>
  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_plot</span> <span class="op">+</span> 
    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.71</span>, label <span class="op">=</span> <span class="va">away_score</span>, color <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">away_color</span>, size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.29</span>, label <span class="op">=</span> <span class="va">home_score</span>, color <span class="op">=</span> <span class="va">game</span><span class="op">$</span><span class="va">home_color</span>, size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">annotate</span><span class="op">(</span><span class="st">"text"</span>, x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">*</span><span class="va">x_score</span>, y <span class="op">=</span> <span class="fl">0.50</span>, label <span class="op">=</span> <span class="va">clock</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, size <span class="op">=</span> <span class="fl">6</span><span class="op">)</span>
  
  <span class="co"># label key moments</span>
  <span class="va">frm_labels</span> <span class="op">&lt;-</span> <span class="va">frm_data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">text</span> <span class="op">!=</span> <span class="st">""</span><span class="op">)</span>
  <span class="va">frm_plot</span> <span class="op">&lt;-</span> <span class="va">frm_plot</span> <span class="op">+</span>
    <span class="fu">geom_point</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">wp</span><span class="op">)</span>,
               color <span class="op">=</span> <span class="st">"#000000"</span>, size <span class="op">=</span> <span class="fl">2</span>, show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_segment</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_text</span>, xend <span class="op">=</span> <span class="va">s</span>, y <span class="op">=</span> <span class="va">y_text</span>, yend <span class="op">=</span> <span class="va">wp</span><span class="op">)</span>,
                 linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu">geom_label</span><span class="op">(</span><span class="va">frm_labels</span>, mapping <span class="op">=</span> <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_text</span>, y <span class="op">=</span> <span class="va">y_text</span>, label <span class="op">=</span> <span class="va">text</span><span class="op">)</span>,
               size <span class="op">=</span> <span class="fl">3</span>, color <span class="op">=</span> <span class="st">"#000000"</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span>, alpha <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span>
  
  <span class="co"># plot the frame</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">frm_plot</span>, width <span class="op">=</span> <span class="fl">12.5</span>, height <span class="op">=</span> <span class="fl">6.47</span>, dpi <span class="op">=</span> <span class="fl">500</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Letâ€™s test our function to make sure the plot looks like how we want it by running our function with 6 minutes left in the game.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">draw_frame</span><span class="op">(</span><span class="fl">360</span><span class="op">)</span></code></pre></div>
<p><img src="animated-wp-plotting_files/figure-html/draw_test-1.png" width="700"></p>
<p>Looks great, so next we create the <code>draw_game()</code> function which will draw every frame for our GIF.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">draw_game</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span>
<span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span>, <span class="kw">function</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span>
  <span class="op">{</span> 
    <span class="fu">draw_frame</span><span class="op">(</span><span class="va">n_sec</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Plotting frames for pause"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">replicate</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fu">draw_frame</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">wp_data</span><span class="op">$</span><span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="st">"Assembling plots into a GIF"</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="animating" class="section level2">
<h2 class="hasAnchor">
<a href="#animating" class="anchor"></a>Animating</h2>
<p>Finally, we run our <code>draw_game()</code> function inside of <code>saveGIF()</code>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = "animated_wp.gif")</span></code></pre></div>
<div class="figure">
<img src="https://github.com/saiemgilani/cfbfastR/blob/master/man/figures/animated_wp.gif?raw=true" alt=""><p class="caption">Result</p>
</div>
<p>This process takes awhile, about 3 minutes on my computer. We can also re-size our GIF using the <code>ani.width</code>, <code>ani.height</code> and <code>ani.res</code> parameters. I like to make my plots wider and at higher resolution, but be careful, this will drastically increase the rendering time and the file size.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># saveGIF(draw_game(), interval = 0.1, movie.name = 'animated_wp_wide.gif',</span>
<span class="co">#         ani.width = 800, ani.height = 500, ani.res = 110)</span></code></pre></div>
<div class="figure">
<img src="https://kazink36.github.io/images/animated_wp_ex_wide.gif" alt=""><p class="caption">Result</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://twitter.com/saiemgilani">Saiem Gilani</a>, <a href="https://twitter.com/akeaswaran">Akshay Easwaran</a>, <a href="https://twitter.com/JaredDLee">Jared Lee</a>, <a href="https://twitter.com/arbitanalytics">Eric Hess</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '002e977de61519c48dce057f58ed1d24',
    indexName: 'cfbfastR',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
